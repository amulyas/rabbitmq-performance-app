<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>RabbitMQ Performance</title>
    <link href="perf.css" rel="stylesheet" type="text/css">
    <link href="loading-animation.css" rel="stylesheet" type="text/css">
    <!--[if lte IE 8]><script language="javascript" type="text/javascript" src="lib/excanvas.min.js"></script><![endif]-->
    <script language="javascript" type="text/javascript" src="lib/jquery-3.1.1.min.js"></script>
    <script language="javascript" type="text/javascript" src="lib/jquery.flot.min.js"></script>
    <script language="javascript" type="text/javascript" src="perf.js"></script>

    <style type="text/css">
      body {
        background: #f06d06;
      }
      .row {
        background: #ffffff;
        margin: 20px 0;
        padding: 10px;
        overflow: auto;
      }
      /*
      #main div {
        padding: 15px;
        width: 400px;
        margin: 5px;
      }
      .inline-block-center {
        text-align: center;
      }
      .inline-block-center div {
        display: inline-block;
        text-align: left;
      }
      */

      .hide {
        display: none;
      }
      .configs, .chartParent {
        float: left;
        height: 400px;
        margin: 1%;
      }
      textarea {
        width: 100%;
        height: 70%;
      }
      .configs {
        width: 25%;
      }
      .chartParent {
        width: 42%;
        min-width: 650px;
      }
    </style>
    <script language="javascript" type="text/javascript">

    var loadingTemplate = `
        <div class="sk-folding-cube">
             <div class="sk-cube1 sk-cube"></div>
             <div class="sk-cube2 sk-cube"></div>
             <div class="sk-cube4 sk-cube"></div>
             <div class="sk-cube3 sk-cube"></div>
           </div>`;

    var newGraph = function(parent, scenarioConfig) {
      return {
        ui: {},
        init: function() {
          var that = this;
          this.ui = $(`<div><div class="configs">
    <h2>Scenario Config</h2>
    <textarea class="scenarioConfig">${this.defaultScenarioConfig}</textarea>
  <button class="submitScenario">submit</button>
  </div>

  <div class="configs">
    <h2>Graph Config</h2>
    <textarea class="graphConfig">${this.defaultConfig}</textarea>
  <button class="submitDraw">draw</button>
  </div>
  <div class="chartParent box">
    <h3 class="heading"></h3>
    </div></div>`);

          this.parent = this.ui.find('.chartParent');
          // add click listeners
          this.ui.find('.submitScenario').click(function() {

            // get the latest scenario configs
            that.scenarioConfig = JSON.parse(that.ui.find('.scenarioConfig').val());
           
            that.drawLoading();
            that.runScenario();
          });

          this.ui.find('.submitDraw').click(function() {
            that.draw();
          });
          return this.ui;
        },
        graph: $('<div class="chart"></div>'),
        defaultConfig: `[
  {"data-type":"time"},
  {"data-latency":"true"},
  {"data-x-axis":"time (s)"},
  {"data-y-axis":"rate (msg/s)"},
  {"data-y-axis2":"latency (Î¼s)"}
]`,
        defaultScenarioConfig: `[{ 
"name": "consume", 
"type": "simple",
"uri": "amqp://296d03f3-539b-467c-afd6-f510a7528827:e5d03acnkou3l0tga785btnc4n@rabbitmq-sb.svc.asv.ice.gecis.io:5672/b4a6d819-60fc-400a-8586-243b24de0eba",
"params": [{
  "time-limit": 10,
  "producer-count": 4, 
  "consumer-count": 2, 
  "queue-name": "queue_name2" 
}] 
}]`,
        scenarioResults: {},
        scenarioConfig: {},
        config: {},
        parent: {},
        heading: $('<h3 class="heading"></h3>'),
        clear: function() {
          this.graph.html("");
          this.parent.html("");
        },
        draw: function() {

          var graph = this.graph,
            heading = this.heading,
            parent = this.parent,
            name = this.scenarioConfig[0].name;

          this.clear();

          this.config = JSON.parse(this.ui.find('.graphConfig').val());
          // write graph heading
          parent.append(heading.html(name));

          // set the name
          graph.attr("data-scenario", name);
          this.config.forEach(function(config) {
            graph.attr(Object.keys(config)[0], config[Object.keys(config)[0]]); 
          });

          // add graph div
          parent.append(graph);
          render_graphs(this.results, graph);
        },
        drawLoading: function() {
          // add loading animation
          this.clear();
          this.parent.html(loadingTemplate);
        },
        runScenario: function() {

          var that = this;

          $.ajax({
              url: '/perftest',
              type: 'POST',
              data: JSON.stringify(that.scenarioConfig),
              dataType: "json",
              contentType: "application/json",
              success: function(data) {
                  that.results = data.results;
                  that.draw();
              },
              fail: function() { alert('error loading performance tests'); }
          });
        }
      };
    }


    $(document).ready(function() {

      graph = newGraph();
      $('#main').append(graph.init());

      graph2 = newGraph();
      $('#main2').append(graph2.init());

      graph3 = newGraph();
      $('#main3').append(graph3.init());

    });
    </script>
 </head>
    <body>
    <h1>RabbitMQ Performance Tests</h1>
    <div id="main" class="row"></div>
    <div id="main2" class="row"></div>
    <div id="main3" class="row"></div>
</body>
</html>
